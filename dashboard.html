<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; color: #333; }
    h1 { text-align: center; color: #222; }
    .back-btn { position: fixed; top: 20px; right: 20px; background: #0d47a1; color: white; padding: 10px 16px; border-radius: 8px; text-decoration: none; font-weight: bold; z-index: 1000; }
    #search { margin: 20px auto; display: block; max-width: 400px; width: 100%; padding: 12px; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; }
    #products { max-width: 900px; margin: auto; display: grid; grid-template-columns: repeat(auto-fill,minmax(280px,1fr)); gap: 15px; }
    .product-box { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 10px; position: relative; }
    .product-id { font-weight: bold; color: #555; word-break: break-word; font-size: 14px; }
    .price-input, .name-input, .cost-input, .stock-input, .max-order-input { padding: 10px; font-size: 14px; border: 1px solid #ccc; border-radius: 6px; }
    .btn { padding: 10px; font-size: 14px; border: none; border-radius: 6px; cursor: pointer; }
    .update-btn { background: #007bff; color: white; }
    .delete-btn { background: #dc3545; color: white; }
    .offer-btn { background: #28a745; color: white; }
    .remove-offer-btn { background: #ffc107; color: black; }
    .availability-btn { background: #6c757d; color: white; }
    .make-available-btn { background: #17a2b8; color: white; }
    .add-section { max-width: 900px; margin: 40px auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .add-section input { margin: 10px 0; width: 100%; }
    #alert { margin: 20px auto; max-width: 900px; padding: 10px; border-radius: 8px; display: none; text-align: center; font-weight: bold; }
    #alert.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    #alert.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    #filter-buttons { max-width: 900px; margin: 10px auto 20px auto; text-align: center; }
    #filter-buttons button {
      margin: 0 10px;
      padding: 10px 20px;
      font-size: 15px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    #filter-buttons button.active {
      background-color: #007bff;
      color: white;
    }
    #filter-buttons button:not(.active) {
      background-color: #e0e0e0;
      color: #333;
    }
    .profit-info {
      font-size: 12px;
      color: #28a745;
      font-weight: bold;
      margin-top: 5px;
    }
    .availability-badge {
      position: absolute;
      top: 10px;
      left: 10px;
      background: #dc3545;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }
    .deleted-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #ff5722;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }
    .availability-checkbox {
      display: flex;
      align-items: center;
      margin-top: 10px;
      gap: 8px;
    }
    .stock-info {
      font-size: 12px;
      color: #007bff;
      font-weight: bold;
      margin-top: 5px;
    }
    .max-order-info {
      font-size: 12px;
      color: #ff5722;
      font-weight: bold;
      margin-top: 5px;
    }
    .low-stock {
      color: #dc3545;
      font-weight: bold;
    }
    .unlimited-stock-btn {
      background: #9c27b0;
      color: white;
    }
    .limited-stock-btn {
      background: #795548;
      color: white;
    }
    .unlimited-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #9c27b0;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }
    .last-updated-info {
      font-size: 10px;
      color: #666;
      margin-top: 5px;
      font-style: italic;
    }
  </style>
</head>
<body>

<a href="index.html" class="back-btn">â† Ø±Ø¬ÙˆØ¹</a>
<h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h1>

<div id="filter-buttons">
  <button id="show-all-btn" class="active">Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
  <button id="show-offers-btn">Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ø±ÙˆØ¶ ÙÙ‚Ø·</button>
  <button id="show-low-stock-btn">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…Ù†Ø®ÙØ¶</button>
  <button id="show-unavailable-btn">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ØªÙˆÙØ±Ø©</button>
  <button id="show-deleted-btn">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©</button>
</div>

<input type="text" id="search" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬..." />
<div id="alert"></div>
<div id="products">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

<div class="add-section">
  <h3>â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h3>
  <input type="text" id="new-id" placeholder="Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ù†ØªØ¬ (product-id)" />
  <input type="text" id="new-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" />
  <input type="number" id="new-cost" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ (Ø¬Ù†ÙŠÙ‡)" />
  <input type="number" id="new-price" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ (Ø¬Ù†ÙŠÙ‡)" />
  <input type="number" id="new-stock" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø®Ø²Ù†" value="0" min="0" />
  <input type="number" id="new-max-order" placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø·Ù„Ø¨ (0 = Ù„Ø§ Ø­Ø¯ÙˆØ¯)" value="0" min="0" />
  <div class="availability-checkbox">
    <input type="checkbox" id="new-available" checked>
    <label for="new-available">Ø§Ù„Ù…Ù†ØªØ¬ Ù…ØªÙˆÙØ±</label>
  </div>
  <div class="availability-checkbox">
    <input type="checkbox" id="new-unlimited-stock">
    <label for="new-unlimited-stock">Ø§Ù„Ø´ØºÙ„ Ø¹Ù„ÙŠ Ø§Ù„Ù…ÙƒØ´ÙˆÙ (Ù…Ø®Ø²ÙˆÙ† ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯)</label>
  </div>
  <button class="btn update-btn" onclick="addProduct()">Ø¥Ø¶Ø§ÙØ©</button>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBKtxMNJ3n_YIsy671sbhlk8Qm1yt5uSB4",
    authDomain: "mostafa-products.firebaseapp.com",
    projectId: "mostafa-products",
    storageBucket: "mostafa-products.firebasestorage.app",
    messagingSenderId: "841270845665",
    appId: "1:841270845665:web:f2f857112688b8b8be57a0"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const productsDiv = document.getElementById("products");
  const alertDiv = document.getElementById("alert");
  const searchInput = document.getElementById("search");
  const showAllBtn = document.getElementById("show-all-btn");
  const showOffersBtn = document.getElementById("show-offers-btn");
  const showLowStockBtn = document.getElementById("show-low-stock-btn");
  const showUnavailableBtn = document.getElementById("show-unavailable-btn");
  const showDeletedBtn = document.getElementById("show-deleted-btn");

  function showAlert(msg, type = "success") {
    alertDiv.textContent = msg;
    alertDiv.className = type === "error" ? "error" : "success";
    alertDiv.style.display = "block";
    setTimeout(() => alertDiv.style.display = "none", 3000);
  }

  function formatTimestamp(timestamp) {
    if (!timestamp) return "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
    try {
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      return date.toLocaleString('ar-EG');
    } catch (e) {
      return "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
    }
  }

  let allProducts = [];
  let allOffers = {};
  let filteredProducts = [];
  let currentFilter = "all";

  function createSafeId(id) {
    return id.replace(/[^a-zA-Z0-9-_]/g, '_');
  }

  // ========== Ù†Ø¸Ø§Ù… Ø§Ù„Ù€ Cache Ù…Ø¹ localStorage ==========
  function updateProductLocally(productId, newData) {
    const index = allProducts.findIndex(p => p.id === productId);
    if (index !== -1) {
      allProducts[index] = { ...allProducts[index], ...newData };
      saveToLocalStorage();
      applyFilterAndRender();
      return true;
    }
    return false;
  }

  function deleteProductLocally(productId) {
    allProducts = allProducts.filter(p => p.id !== productId);
    delete allOffers[productId];
    saveToLocalStorage();
    applyFilterAndRender();
  }

  function addProductLocally(productData) {
    allProducts.push(productData);
    saveToLocalStorage();
    applyFilterAndRender();
  }

  function updateOfferLocally(productId, isOffer) {
    if (isOffer) {
      allOffers[productId] = true;
    } else {
      delete allOffers[productId];
    }
    
    const index = allProducts.findIndex(p => p.id === productId);
    if (index !== -1) {
      allProducts[index].isOffer = isOffer;
      saveToLocalStorage();
      applyFilterAndRender();
    }
  }

  function saveToLocalStorage() {
    const cacheData = {
      products: allProducts,
      offers: allOffers,
      timestamp: Date.now()
    };
    localStorage.setItem('productsCache', JSON.stringify(cacheData));
  }

  function loadFromLocalStorage() {
    const cached = localStorage.getItem('productsCache');
    if (!cached) return false;
    
    try {
      const data = JSON.parse(cached);
      allProducts = data.products || [];
      allOffers = data.offers || {};
      return true;
    } catch (e) {
      console.log('âŒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„ÙŠ');
      return false;
    }
  }

  function clearLocalStorage() {
    localStorage.removeItem('productsCache');
  }

  async function loadProducts(forceRefresh = false) {
    productsDiv.innerHTML = "Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
    
    if (!forceRefresh && loadFromLocalStorage()) {
      applyFilterAndRender();
      showAlert("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„ÙŠ");
      updateBulkUnlimitedButton();
      return;
    }
    
    try {
      const [productsSnapshot, offersSnapshot] = await Promise.all([
        db.collection("products").get(),
        db.collection("offers").get()
      ]);

      allOffers = {};
      offersSnapshot.forEach(doc => {
        allOffers[doc.id] = true;
      });

      allProducts = [];
      productsSnapshot.forEach(doc => {
        const data = doc.data();
        allProducts.push({ 
          id: doc.id, 
          ...data, 
          isOffer: !!allOffers[doc.id],
          available: data.available !== undefined ? data.available : true,
          stock: data.stock !== undefined ? data.stock : 0,
          maxOrder: data.maxOrder !== undefined ? data.maxOrder : 0,
          unlimitedStock: data.unlimitedStock !== undefined ? data.unlimitedStock : false,
          lastUpdated: data.lastUpdated || null,
          deleted: data.deleted || false
        });
      });

      saveToLocalStorage();
      applyFilterAndRender();
      updateBulkUnlimitedButton();
      
    } catch (e) {
      showAlert("âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª", "error");
      console.error(e);
    }
  }

  function applyFilterAndRender() {
    if (currentFilter === "offers") {
      filteredProducts = allProducts.filter(p => p.isOffer);
    } else if (currentFilter === "low-stock") {
      filteredProducts = allProducts.filter(p => p.stock < 10 && p.stock > 0 && !p.deleted);
    } else if (currentFilter === "unavailable") {
      filteredProducts = allProducts.filter(p => !p.available && !p.deleted);
    } else if (currentFilter === "deleted") {
      filteredProducts = allProducts.filter(p => p.deleted);
    } else {
      filteredProducts = allProducts.filter(p => !p.deleted); // Ø¹Ø±Ø¶ ØºÙŠØ± Ø§Ù„Ù…Ø­Ø°ÙˆÙÙŠÙ† Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
    }

    const searchTerm = searchInput.value.trim().toLowerCase();
    if (searchTerm) {
      filteredProducts = filteredProducts.filter(p => p.name?.toLowerCase().includes(searchTerm));
    }

    renderProducts(filteredProducts);
  }

  function renderProducts(products) {
    productsDiv.innerHTML = "";
    if (products.length === 0) {
      productsDiv.innerHTML = "<p style='text-align:center; color:#666;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</p>";
      return;
    }

    products.forEach(product => {
      const profit = product.price && product.cost ? (product.price - product.cost) : 0;
      const safeId = createSafeId(product.id);
      
      const box = document.createElement("div");
      box.className = "product-box";
      
      if (!product.available && !product.deleted) {
        const badge = document.createElement("div");
        badge.className = "availability-badge";
        badge.textContent = "ØºÙŠØ± Ù…ØªÙˆÙØ±";
        box.appendChild(badge);
      }
      
      if (product.deleted) {
        const deletedBadge = document.createElement("div");
        deletedBadge.className = "deleted-badge";
        deletedBadge.textContent = "Ù…Ø­Ø°ÙˆÙ";
        box.appendChild(deletedBadge);
      }
      
      if (product.unlimitedStock && !product.deleted) {
        const unlimitedBadge = document.createElement("div");
        unlimitedBadge.className = "unlimited-badge";
        unlimitedBadge.textContent = "Ù…Ø®Ø²ÙˆÙ† ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯";
        box.appendChild(unlimitedBadge);
      }
      
      box.innerHTML = `
        <div class="product-id">
          ğŸ†” ${product.id}
          ${product.isOffer ? '<span style="color: #28a745; font-weight: bold; margin-right: 10px;">ğŸ“¢ Ø¹Ù„Ù‰ Ø¹Ø±Ø¶</span>' : ''}
        </div>
        <input class="name-input" value="${product.name || ''}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" />
        <small>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</small>
        <input style="color: red !important; font-size:25px"  class="cost-input" type="number" value="${product.cost || ''}" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡" />
        <small>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</small>
        <input  style="color: green !important; font-size:25px " class="price-input" type="number" value="${product.price || ''}" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹" />
        ${profit > 0 ? `<div class="profit-info">ğŸ’° Ø§Ù„Ø±Ø¨Ø­: ${profit.toFixed(2)} Ø¬ (${((profit / product.cost) * 100).toFixed(2)}%)</div>` : ''}
        
        <small>Ø§Ù„ÙƒÙ…ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø®Ø²Ù†</small>
        <input class="stock-input" type="number" value="${product.stock || 0}" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø®Ø²Ù†" min="0" />
        
        <small>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø·Ù„Ø¨ (0 = Ù„Ø§ Ø­Ø¯ÙˆØ¯)</small>
        <input class="max-order-input" type="number" value="${product.maxOrder || 0}" placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø·Ù„Ø¨" min="0" />
        
        ${product.lastUpdated ? `<div class="last-updated-info">ğŸ•’ Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${formatTimestamp(product.lastUpdated)}</div>` : ''}
        
        ${product.stock > 0 && !product.unlimitedStock ? 
          `<div class="stock-info">ğŸ“¦ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: ${product.stock} ÙˆØ­Ø¯Ø©</div>` : 
          product.unlimitedStock ?
          `<div class="stock-info" style="color: #9c27b0;">â™¾ï¸ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯</div>` :
          `<div class="stock-info low-stock">â›” Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: Ù†Ø§ÙØ°</div>`}
        
        ${product.maxOrder > 0 ? 
          `<div class="max-order-info">ğŸ“‹ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø·Ù„Ø¨: ${product.maxOrder} ÙˆØ­Ø¯Ø©</div>` : 
          `<div class="max-order-info">ğŸ“‹ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø¯ Ø£Ù‚ØµÙ‰ Ù„Ù„Ø·Ù„Ø¨</div>`}
        
        ${!product.deleted ? `
          <div class="availability-checkbox">
            <input type="checkbox" id="available-${safeId}" ${product.available ? 'checked' : ''}>
            <label for="available-${safeId}">Ø§Ù„Ù…Ù†ØªØ¬ Ù…ØªÙˆÙØ±</label>
          </div>
          
          <div class="availability-checkbox">
            <input type="checkbox" id="unlimited-stock-${safeId}" ${product.unlimitedStock ? 'checked' : ''}>
            <label for="unlimited-stock-${safeId}">Ø§Ù„Ø´ØºÙ„ Ø¹Ù„ÙŠ Ø§Ù„Ù…ÙƒØ´ÙˆÙ (Ù…Ø®Ø²ÙˆÙ† ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯)</label>
          </div>
          
          <button class="btn update-btn">ğŸ’¾ ØªØ­Ø¯ÙŠØ«</button>
          <button class="btn delete-btn">${product.deleted ? 'â™»ï¸ Ø¥Ø³ØªØ¹Ø§Ø¯Ø©' : 'ğŸ—‘ï¸ Ø­Ø°Ù'}</button>
          <button class="btn offer-btn">ğŸ“¢ Ø¹Ø±Ø¶ ÙƒØ¹Ø±Ø¶</button>
          <button class="btn remove-offer-btn">âŒ Ø­Ø°Ù Ø§Ù„Ø¹Ø±Ø¶</button>
          ${product.available ? 
            '<button class="btn availability-btn">âŒ ÙˆØ¶Ø¹ ÙƒØºÙŠØ± Ù…ØªÙˆÙØ±</button>' : 
            '<button class="btn make-available-btn">âœ… ÙˆØ¶Ø¹ ÙƒÙ…ØªÙˆÙØ±</button>'}
          ${product.unlimitedStock ?
            '<button class="btn limited-stock-btn">ğŸ”’ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø´ØºÙ„ Ø¹Ù„ÙŠ Ø§Ù„Ù…ÙƒØ´ÙˆÙ</button>' :
            '<button class="btn unlimited-stock-btn">â™¾ï¸ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø´ØºÙ„ Ø¹Ù„ÙŠ Ø§Ù„Ù…ÙƒØ´ÙˆÙ</button>'}
        ` : `
          <div style="color: #ff5722; font-weight: bold; padding: 10px; background: #fff3e0; border-radius: 5px;">
            âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ø­Ø°ÙˆÙ (Soft Delete)
          </div>
          <button class="btn update-btn" style="background: #4CAF50;">â™»ï¸ Ø¥Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ù†ØªØ¬</button>
          <button class="btn delete-btn" style="background: #f44336;">ğŸ—‘ï¸ Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button>
        `}
      `;

      if (!product.deleted) {
        const nameInput = box.querySelector('.name-input');
        const costInput = box.querySelector('.cost-input');
        const priceInput = box.querySelector('.price-input');
        const stockInput = box.querySelector('.stock-input');
        const maxOrderInput = box.querySelector('.max-order-input');
        const updateBtn = box.querySelector('.update-btn');
        const deleteBtn = box.querySelector('.delete-btn');
        const offerBtn = box.querySelector('.offer-btn');
        const removeOfferBtn = box.querySelector('.remove-offer-btn');
        const availabilityBtn = box.querySelector('.availability-btn') || box.querySelector('.make-available-btn');
        const unlimitedStockBtn = box.querySelector('.unlimited-stock-btn') || box.querySelector('.limited-stock-btn');
        const availabilityCheckbox = box.querySelector(`#available-${safeId}`);
        const unlimitedStockCheckbox = box.querySelector(`#unlimited-stock-${safeId}`);

        updateBtn.onclick = async () => {
          const newName = nameInput.value.trim();
          const newCost = parseFloat(costInput.value.trim());
          const newPrice = parseFloat(priceInput.value.trim());
          const newStock = parseInt(stockInput.value.trim());
          const newMaxOrder = parseInt(maxOrderInput.value.trim());
          const newAvailable = availabilityCheckbox.checked;
          const newUnlimitedStock = unlimitedStockCheckbox.checked;
          
          if (!newName || isNaN(newCost) || isNaN(newPrice) || isNaN(newStock) || isNaN(newMaxOrder)) {
            showAlert("âŒ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø³Ø¹Ø± Ø£Ùˆ Ø§Ù„ÙƒÙ…ÙŠØ© ØºÙŠØ± ØµØ§Ù„Ø­Ø©", "error");
            return;
          }
          
          try {
            const now = firebase.firestore.FieldValue.serverTimestamp();
            
            await db.collection("products").doc(product.id).set({ 
              name: newName, 
              cost: newCost,
              price: newPrice,
              stock: newStock,
              maxOrder: newMaxOrder,
              available: newAvailable,
              unlimitedStock: newUnlimitedStock,
              lastUpdated: now  // â¬…ï¸ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ timestamp
            }, { merge: true });
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø§Ù…
            await db.collection('system').doc('update').update({
              lastProductsUpdate: now,
              globalLastUpdate: now
            });
            
            updateProductLocally(product.id, {
              name: newName,
              cost: newCost,
              price: newPrice,
              stock: newStock,
              maxOrder: newMaxOrder,
              available: newAvailable,
              unlimitedStock: newUnlimitedStock,
              lastUpdated: now
            });
            
            showAlert(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬ (${product.id})`);
          } catch (e) {
            showAlert("âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«", "error");
            console.error(e);
          }
        };

        deleteBtn.onclick = async () => {
          if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ (${product.id})ØŸ\n\nØ³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬ ÙƒÙ…Ø­Ø°ÙˆÙ (Soft Delete) ÙˆÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡ Ù„Ø§Ø­Ù‚Ø§Ù‹.`)) {
            try {
              const now = firebase.firestore.FieldValue.serverTimestamp();
              
              // Soft Delete
              await db.collection("products").doc(product.id).set({ 
                deleted: true,
                lastUpdated: now
              }, { merge: true });
              
              // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø§Ù…
              await db.collection('system').doc('update').update({
                lastProductsUpdate: now,
                globalLastUpdate: now
              });
              
              updateProductLocally(product.id, { 
                deleted: true,
                lastUpdated: now
              });
              
              showAlert("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ (ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡)");
            } catch (e) {
              showAlert("âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­Ø°Ù", "error");
              console.error(e);
            }
          }
        };

        offerBtn.onclick = async () => {
          const name = nameInput.value.trim();
          const price = parseFloat(priceInput.value.trim());
          if (!name || isNaN(price)) {
            showAlert("âŒ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø³Ø¹Ø± ØºÙŠØ± ØµØ§Ù„Ø­", "error");
            return;
          }
          try {
            await db.collection("offers").doc(product.id).set({ name, price });
            updateOfferLocally(product.id, true);
            showAlert("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±ÙˆØ¶");
          } catch (e) {
            showAlert("âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø±Ø¶", "error");
            console.error(e);
          }
        };

        removeOfferBtn.onclick = async () => {
          try {
            await db.collection("offers").doc(product.id).delete();
            updateOfferLocally(product.id, false);
            showAlert("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ø±Ø¶ Ù…Ù† Ø§Ù„Ø¹Ø±ÙˆØ¶");
          } catch (e) {
            showAlert("âŒ ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¹Ø±Ø¶", "error");
            console.error(e);
          }
        };

        availabilityBtn.onclick = async () => {
          try {
            const now = firebase.firestore.FieldValue.serverTimestamp();
            const newAvailability = !product.available;
            await db.collection("products").doc(product.id).set({ 
              available: newAvailability,
              lastUpdated: now
            }, { merge: true });
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø§Ù…
            await db.collection('system').doc('update').update({
              lastProductsUpdate: now
            });
            
            updateProductLocally(product.id, { 
              available: newAvailability,
              lastUpdated: now
            });
            showAlert(`âœ… ØªÙ… ${newAvailability ? 'ØªÙ…ÙƒÙŠÙ†' : 'ØªØ¹Ø·ÙŠÙ„'} Ø§Ù„Ù…Ù†ØªØ¬`);
          } catch (e) {
            showAlert("âŒ ÙØ´Ù„ ÙÙŠ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆÙØ±", "error");
            console.error(e);
          }
        };

        unlimitedStockBtn.onclick = async () => {
          try {
            const now = firebase.firestore.FieldValue.serverTimestamp();
            const newUnlimitedStock = !product.unlimitedStock;
            await db.collection("products").doc(product.id).set({ 
              unlimitedStock: newUnlimitedStock,
              lastUpdated: now
            }, { merge: true });
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø§Ù…
            await db.collection('system').doc('update').update({
              lastProductsUpdate: now
            });
            
            updateProductLocally(product.id, { 
              unlimitedStock: newUnlimitedStock,
              lastUpdated: now
            });
            showAlert(`âœ… ØªÙ… ${newUnlimitedStock ? 'ØªÙØ¹ÙŠÙ„' : 'Ø¥ÙŠÙ‚Ø§Ù'} Ø§Ù„Ø´ØºÙ„ Ø¹Ù„ÙŠ Ø§Ù„Ù…ÙƒØ´ÙˆÙ`);
          } catch (e) {
            showAlert("âŒ ÙØ´Ù„ ÙÙŠ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†", "error");
            console.error(e);
          }
        };
      } else {
        // Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©
        const restoreBtn = box.querySelector('.update-btn');
        const permanentDeleteBtn = box.querySelector('.delete-btn');

        restoreBtn.onclick = async () => {
          if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ù†ØªØ¬ (${product.id})ØŸ`)) {
            try {
              const now = firebase.firestore.FieldValue.serverTimestamp();
              
              await db.collection("products").doc(product.id).set({ 
                deleted: false,
                lastUpdated: now
              }, { merge: true });
              
              // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø§Ù…
              await db.collection('system').doc('update').update({
                lastProductsUpdate: now,
                globalLastUpdate: now
              });
              
              updateProductLocally(product.id, { 
                deleted: false,
                lastUpdated: now
              });
              
              showAlert("âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ù†ØªØ¬");
            } catch (e) {
              showAlert("âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©", "error");
              console.error(e);
            }
          }
        };

        permanentDeleteBtn.onclick = async () => {
          if (confirm(`âš ï¸ ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ø§ Ø§Ù„Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ!\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ (${product.id}) Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ`)) {
            try {
              await db.collection("products").doc(product.id).delete();
              await db.collection("offers").doc(product.id).delete().catch(() => {});
              deleteProductLocally(product.id);
              showAlert("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹");
            } catch (e) {
              showAlert("âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ", "error");
              console.error(e);
            }
          }
        };
      }

      productsDiv.appendChild(box);
    });
  }

  searchInput.addEventListener("input", () => {
    applyFilterAndRender();
  });

  showAllBtn.onclick = () => {
    currentFilter = "all";
    setActiveFilterButton();
    applyFilterAndRender();
  };

  showOffersBtn.onclick = () => {
    currentFilter = "offers";
    setActiveFilterButton();
    applyFilterAndRender();
  };

  showLowStockBtn.onclick = () => {
    currentFilter = "low-stock";
    setActiveFilterButton();
    applyFilterAndRender();
  };

  showUnavailableBtn.onclick = () => {
    currentFilter = "unavailable";
    setActiveFilterButton();
    applyFilterAndRender();
  };

  showDeletedBtn.onclick = () => {
    currentFilter = "deleted";
    setActiveFilterButton();
    applyFilterAndRender();
  };

  function setActiveFilterButton() {
    showAllBtn.classList.remove("active");
    showOffersBtn.classList.remove("active");
    showLowStockBtn.classList.remove("active");
    showUnavailableBtn.classList.remove("active");
    showDeletedBtn.classList.remove("active");
    
    if (currentFilter === "all") {
      showAllBtn.classList.add("active");
    } else if (currentFilter === "offers") {
      showOffersBtn.classList.add("active");
    } else if (currentFilter === "low-stock") {
      showLowStockBtn.classList.add("active");
    } else if (currentFilter === "unavailable") {
      showUnavailableBtn.classList.add("active");
    } else if (currentFilter === "deleted") {
      showDeletedBtn.classList.add("active");
    }
  }

  async function addProduct() {
    const id = document.getElementById("new-id").value.trim();
    const name = document.getElementById("new-name").value.trim();
    const cost = parseFloat(document.getElementById("new-cost").value.trim());
    const price = parseFloat(document.getElementById("new-price").value.trim());
    const stock = parseInt(document.getElementById("new-stock").value.trim());
    const maxOrder = parseInt(document.getElementById("new-max-order").value.trim());
    const available = document.getElementById("new-available").checked;
    const unlimitedStock = document.getElementById("new-unlimited-stock").checked;

    if (!id || !name || isNaN(cost) || isNaN(price) || isNaN(stock) || isNaN(maxOrder)) {
      showAlert("âŒ Ø£Ø¯Ø®Ù„ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­", "error");
      return;
    }

    try {
      const now = firebase.firestore.FieldValue.serverTimestamp();
      
      await db.collection("products").doc(id).set({ 
        name, 
        cost, 
        price, 
        stock, 
        maxOrder, 
        available,
        unlimitedStock,
        lastUpdated: now,    // â¬…ï¸ ØªØ³Ø¬ÙŠÙ„ ÙˆÙ‚Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©
        deleted: false       // â¬…ï¸ Ø§Ù„Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯ ÙˆØºÙŠØ± Ù…Ø­Ø°ÙˆÙ
      });
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø§Ù…
      await db.collection('system').doc('update').update({
        lastProductsUpdate: now,
        globalLastUpdate: now
      });
      
      addProductLocally({
        id: id,
        name: name,
        cost: cost,
        price: price,
        stock: stock,
        maxOrder: maxOrder,
        available: available,
        unlimitedStock: unlimitedStock,
        lastUpdated: now,
        deleted: false,
        isOffer: false
      });
      
      showAlert("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬");
      document.getElementById("new-id").value = '';
      document.getElementById("new-name").value = '';
      document.getElementById("new-cost").value = '';
      document.getElementById("new-price").value = '';
      document.getElementById("new-stock").value = '0';
      document.getElementById("new-max-order").value = '0';
      document.getElementById("new-available").checked = true;
      document.getElementById("new-unlimited-stock").checked = false;
    } catch (e) {
      showAlert("âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©", "error");
      console.error(e);
    }
  }

  function addRefreshButton() {
    const filterButtons = document.getElementById("filter-buttons");
    
    const refreshBtn = document.createElement("button");
    refreshBtn.id = "refresh-btn";
    refreshBtn.innerHTML = "ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
    refreshBtn.style.backgroundColor = "#17a2b8";
    refreshBtn.style.color = "white";
    refreshBtn.style.margin = "0 10px";
    refreshBtn.style.padding = "10px 20px";
    refreshBtn.style.fontSize = "15px";
    refreshBtn.style.borderRadius = "8px";
    refreshBtn.style.border = "none";
    refreshBtn.style.cursor = "pointer";
    refreshBtn.style.fontWeight = "bold";
    
    refreshBtn.onclick = async () => {
      refreshBtn.disabled = true;
      refreshBtn.innerHTML = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...";
      
      clearLocalStorage();
      await loadProducts(true);
      refreshBtn.disabled = false;
      refreshBtn.innerHTML = "ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
      showAlert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±");
    };
    
    filterButtons.appendChild(refreshBtn);
  }

  function addGlobalUpdateButton() {
    const filterButtons = document.getElementById("filter-buttons");
    
    const globalUpdateBtn = document.createElement("button");
    globalUpdateBtn.id = "global-update-btn";
    globalUpdateBtn.innerHTML = "ğŸŒ Ø¥Ø´Ø¹Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†";
    globalUpdateBtn.style.backgroundColor = "#2196F3";
    globalUpdateBtn.style.color = "white";
    globalUpdateBtn.style.margin = "0 10px";
    globalUpdateBtn.style.padding = "10px 20px";
    globalUpdateBtn.style.fontSize = "15px";
    globalUpdateBtn.style.borderRadius = "8px";
    globalUpdateBtn.style.border = "none";
    globalUpdateBtn.style.cursor = "pointer";
    globalUpdateBtn.style.fontWeight = "bold";
    
    globalUpdateBtn.onclick = async () => {
      if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø´Ø¹Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨ÙˆØ¬ÙˆØ¯ ØªØ­Ø¯ÙŠØ«Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©ØŸ\n\nØ³ÙŠØ¶Ø·Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ù„Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø© ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©.")) {
        return;
      }
      
      try {
        globalUpdateBtn.disabled = true;
        globalUpdateBtn.innerHTML = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±...";
        
        const now = firebase.firestore.FieldValue.serverTimestamp();
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø§Ù… ÙÙ‚Ø·
        await db.collection('system').doc('update').update({
          lastProductsUpdate: now,
          globalLastUpdate: now,
          updateVersion: firebase.firestore.FieldValue.increment(1)
        });
        
        showAlert("âœ… ØªÙ… Ø¥Ø´Ø¹Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©");
        
      } catch (e) {
        showAlert("âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±", "error");
        console.error(e);
      } finally {
        globalUpdateBtn.disabled = false;
        globalUpdateBtn.innerHTML = "ğŸŒ Ø¥Ø´Ø¹Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†";
      }
    };
    
    filterButtons.appendChild(globalUpdateBtn);
  }

  function addBulkUnlimitedStockButton() {
    const filterButtons = document.getElementById("filter-buttons");
    
    const bulkUnlimitedBtn = document.createElement("button");
    bulkUnlimitedBtn.id = "bulk-unlimited-btn";
    bulkUnlimitedBtn.innerHTML = "â™¾ï¸ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
    bulkUnlimitedBtn.style.backgroundColor = "#6c757d";
    bulkUnlimitedBtn.style.color = "white";
    bulkUnlimitedBtn.style.margin = "0 10px";
    bulkUnlimitedBtn.style.padding = "10px 20px";
    bulkUnlimitedBtn.style.fontSize = "15px";
    bulkUnlimitedBtn.style.borderRadius = "8px";
    bulkUnlimitedBtn.style.border = "none";
    bulkUnlimitedBtn.style.cursor = "pointer";
    bulkUnlimitedBtn.style.fontWeight = "bold";
    
    window.updateBulkUnlimitedButton = function() {
      if (!allProducts || allProducts.length === 0) {
        bulkUnlimitedBtn.innerHTML = "â™¾ï¸ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
        bulkUnlimitedBtn.style.backgroundColor = "#6c757d";
        bulkUnlimitedBtn.disabled = true;
        return;
      }
      
      const allUnlimited = allProducts.filter(p => !p.deleted).every(product => product.unlimitedStock);
      
      if (allUnlimited) {
        bulkUnlimitedBtn.innerHTML = "ğŸ”’ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø´ØºÙ„ Ø¹Ù„ÙŠ Ø§Ù„Ù…ÙƒØ´ÙˆÙ Ù„Ù„Ø¬Ù…ÙŠØ¹";
        bulkUnlimitedBtn.style.backgroundColor = "#795548";
      } else {
        bulkUnlimitedBtn.innerHTML = "â™¾ï¸ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø´ØºÙ„ Ø¹Ù„ÙŠ Ø§Ù„Ù…ÙƒØ´ÙˆÙ Ù„Ù„Ø¬Ù…ÙŠØ¹";
        bulkUnlimitedBtn.style.backgroundColor = "#9c27b0";
      }
      
      bulkUnlimitedBtn.disabled = false;
    };
    
    bulkUnlimitedBtn.onclick = async function() {
      if (!allProducts || allProducts.length === 0) return;
      
      const activeProducts = allProducts.filter(p => !p.deleted);
      const allUnlimited = activeProducts.every(product => product.unlimitedStock);
      const action = !allUnlimited;
      const actionText = action ? "ØªÙØ¹ÙŠÙ„" : "Ø¥Ù„ØºØ§Ø¡";
      
      if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ ${actionText} 'Ø§Ù„Ø´ØºÙ„ Ø¹Ù„ÙŠ Ø§Ù„Ù…ÙƒØ´ÙˆÙ' Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© (${activeProducts.length} Ù…Ù†ØªØ¬)ØŸ`)) {
        return;
      }
      
      try {
        bulkUnlimitedBtn.disabled = true;
        bulkUnlimitedBtn.innerHTML = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...";
        
        const batch = db.batch();
        const now = firebase.firestore.FieldValue.serverTimestamp();
        
        activeProducts.forEach(product => {
          const productRef = db.collection("products").doc(product.id);
          batch.update(productRef, { 
            unlimitedStock: action,
            lastUpdated: now
          });
        });
        
        await batch.commit();
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø§Ù…
        await db.collection('system').doc('update').update({
          lastProductsUpdate: now,
          globalLastUpdate: now
        });
        
        showAlert(`âœ… ØªÙ… ${actionText} Ø§Ù„Ø´ØºÙ„ Ø¹Ù„ÙŠ Ø§Ù„Ù…ÙƒØ´ÙˆÙ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©`);
        
        activeProducts.forEach(product => {
          updateProductLocally(product.id, { 
            unlimitedStock: action,
            lastUpdated: now
          });
        });
        
        updateBulkUnlimitedButton();
        
      } catch (e) {
        showAlert("âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«", "error");
        console.error(e);
        bulkUnlimitedBtn.disabled = false;
        updateBulkUnlimitedButton();
      }
    };
    
    filterButtons.appendChild(bulkUnlimitedBtn);
  }

  async function addTimestampsToAllProducts() {
    if (!confirm("âš ï¸ ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·!\n\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¶Ø§ÙØ© timestamps Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©ØŸ")) {
      return;
    }
    
    try {
      showAlert("â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ù€ timestamps...", "success");
      
      const snapshot = await db.collection("products").get();
      const batch = db.batch();
      const now = firebase.firestore.FieldValue.serverTimestamp();
      
      snapshot.forEach(doc => {
        const productRef = db.collection("products").doc(doc.id);
        batch.update(productRef, { 
          lastUpdated: now,
          deleted: false 
        });
      });
      
      await batch.commit();
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø§Ù…
      await db.collection('system').doc('update').set({
        updateVersion: 1,
        lastProductsUpdate: now,
        globalLastUpdate: now,
        updateRequired: true
      }, { merge: true });
      
      showAlert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ù€ timestamps ÙˆØ¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯");
      
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      await loadProducts(true);
      
    } catch (e) {
      showAlert("âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª", "error");
      console.error(e);
    }
  }

  function addInitSystemButton() {
    const filterButtons = document.getElementById("filter-buttons");
    
    const initBtn = document.createElement("button");
    initBtn.id = "init-system-btn";
    initBtn.innerHTML = "âš™ï¸ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯";
    initBtn.style.backgroundColor = "#FF9800";
    initBtn.style.color = "white";
    initBtn.style.margin = "0 10px";
    initBtn.style.padding = "10px 20px";
    initBtn.style.fontSize = "15px";
    initBtn.style.borderRadius = "8px";
    initBtn.style.border = "none";
    initBtn.style.cursor = "pointer";
    initBtn.style.fontWeight = "bold";
    
    initBtn.onclick = () => {
      addTimestampsToAllProducts();
    };
    
    filterButtons.appendChild(initBtn);
  }

  document.addEventListener("DOMContentLoaded", () => {
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user || user.phone !== "01021502941") {
      alert("ğŸ”’ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø´Ø±Ù Ù„Ø¹Ø±Ø¶ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©");
      window.location.href = "login.html";
      return;
    }
    
    addBulkUnlimitedStockButton();
    addRefreshButton();
    addGlobalUpdateButton();
    addInitSystemButton();
    loadProducts();
  });
</script>
</body>
</html>
