<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; color: #333; }
    h1 { text-align: center; color: #222; }
    .back-btn { position: fixed; top: 20px; right: 20px; background: #0d47a1; color: white; padding: 10px 16px; border-radius: 8px; text-decoration: none; font-weight: bold; z-index: 1000; }
    #search { margin: 20px auto; display: block; max-width: 400px; width: 100%; padding: 12px; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; }
    #products { max-width: 900px; margin: auto; display: grid; grid-template-columns: repeat(auto-fill,minmax(280px,1fr)); gap: 15px; }
    .product-box { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 10px; position: relative; }
    .product-id { font-weight: bold; color: #555; word-break: break-word; font-size: 14px; }
    .price-input, .name-input, .cost-input, .stock-input, .max-order-input { padding: 10px; font-size: 14px; border: 1px solid #ccc; border-radius: 6px; }
    .btn { padding: 10px; font-size: 14px; border: none; border-radius: 6px; cursor: pointer; }
    .update-btn { background: #007bff; color: white; }
    .delete-btn { background: #dc3545; color: white; }
    .offer-btn { background: #28a745; color: white; }
    .remove-offer-btn { background: #ffc107; color: black; }
    .availability-btn { background: #6c757d; color: white; }
    .make-available-btn { background: #17a2b8; color: white; }
    .add-section { max-width: 900px; margin: 40px auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .add-section input { margin: 10px 0; width: 100%; }
    #alert { margin: 20px auto; max-width: 900px; padding: 10px; border-radius: 8px; display: none; text-align: center; font-weight: bold; }
    #alert.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    #alert.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    #filter-buttons { max-width: 900px; margin: 10px auto 20px auto; text-align: center; }
    #filter-buttons button {
      margin: 0 10px;
      padding: 10px 20px;
      font-size: 15px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    #filter-buttons button.active {
      background-color: #007bff;
      color: white;
    }
    #filter-buttons button:not(.active) {
      background-color: #e0e0e0;
      color: #333;
    }
    .profit-info {
      font-size: 12px;
      color: #28a745;
      font-weight: bold;
      margin-top: 5px;
    }
    .availability-badge {
      position: absolute;
      top: 10px;
      left: 10px;
      background: #dc3545;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }
    .availability-checkbox {
      display: flex;
      align-items: center;
      margin-top: 10px;
      gap: 8px;
    }
    .stock-info {
      font-size: 12px;
      color: #007bff;
      font-weight: bold;
      margin-top: 5px;
    }
    .max-order-info {
      font-size: 12px;
      color: #ff5722;
      font-weight: bold;
      margin-top: 5px;
    }
    .low-stock {
      color: #dc3545;
      font-weight: bold;
    }
    /* Ø²Ø± Ø§Ù„Ø´ØºÙ„ Ø¹Ù„ÙŠ Ø§Ù„Ù…ÙƒØ´ÙˆÙ */
    .unlimited-stock-btn {
      background: #9c27b0;
      color: white;
    }
    .limited-stock-btn {
      background: #795548;
      color: white;
    }
    .unlimited-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #9c27b0;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }
  </style>
</head>
<body>

<a href="index.html" class="back-btn">â† Ø±Ø¬ÙˆØ¹</a>
<h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h1>

<div id="filter-buttons">
  <button id="show-all-btn" class="active">Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
  <button id="show-offers-btn">Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ø±ÙˆØ¶ ÙÙ‚Ø·</button>
  <button id="show-low-stock-btn">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…Ù†Ø®ÙØ¶</button>
  <button id="show-unavailable-btn">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ØªÙˆÙØ±Ø©</button>
</div>

<input type="text" id="search" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬..." />
<div id="alert"></div>
<div id="products">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

<div class="add-section">
  <h3>â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h3>
  <input type="text" id="new-id" placeholder="Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ù†ØªØ¬ (product-id)" />
  <input type="text" id="new-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" />
  <input type="number" id="new-cost" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ (Ø¬Ù†ÙŠÙ‡)" />
  <input type="number" id="new-price" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ (Ø¬Ù†ÙŠÙ‡)" />
  <input type="number" id="new-stock" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø®Ø²Ù†" value="0" min="0" />
  <input type="number" id="new-max-order" placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø·Ù„Ø¨ (0 = Ù„Ø§ Ø­Ø¯ÙˆØ¯)" value="0" min="0" />
  <div class="availability-checkbox">
    <input type="checkbox" id="new-available" checked>
    <label for="new-available">Ø§Ù„Ù…Ù†ØªØ¬ Ù…ØªÙˆÙØ±</label>
  </div>
  <div class="availability-checkbox">
    <input type="checkbox" id="new-unlimited-stock">
    <label for="new-unlimited-stock">Ø§Ù„Ø´ØºÙ„ Ø¹Ù„ÙŠ Ø§Ù„Ù…ÙƒØ´ÙˆÙ (Ù…Ø®Ø²ÙˆÙ† ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯)</label>
  </div>
  <button class="btn update-btn" onclick="addProduct()">Ø¥Ø¶Ø§ÙØ©</button>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyBKtxMNJ3n_YIsy671sbhlk8Qm1yt5uSB4",
  authDomain: "mostafa-products.firebaseapp.com",
  projectId: "mostafa-products",
  storageBucket: "mostafa-products.firebasestorage.app",
  messagingSenderId: "841270845665",
  appId: "1:841270845665:web:f2f857112688b8b8be57a0"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const productsDiv = document.getElementById("products");
const alertDiv = document.getElementById("alert");
const searchInput = document.getElementById("search");
const showAllBtn = document.getElementById("show-all-btn");
const showOffersBtn = document.getElementById("show-offers-btn");
const showLowStockBtn = document.getElementById("show-low-stock-btn");
const showUnavailableBtn = document.getElementById("show-unavailable-btn");

function showAlert(msg, type = "success") {
  alertDiv.textContent = msg;
  alertDiv.className = type === "error" ? "error" : "success";
  alertDiv.style.display = "block";
  setTimeout(() => alertDiv.style.display = "none", 3000);
}

let allProducts = [];
let allOffers = {};
let filteredProducts = [];
let currentFilter = "all"; // "all", "offers", "low-stock", "unavailable"

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù Ø¢Ù…Ù† Ù„Ù„Ø¹Ù†Ø§ØµØ±
function createSafeId(id) {
  return id.replace(/[^a-zA-Z0-9-_]/g, '_');
}

async function loadProducts() {
  productsDiv.innerHTML = "Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
  try {
    const [productsSnapshot, offersSnapshot] = await Promise.all([
      db.collection("products").get(),
      db.collection("offers").get()
    ]);

    allOffers = {};
    offersSnapshot.forEach(doc => {
      allOffers[doc.id] = true;
    });

    allProducts = [];
    productsSnapshot.forEach(doc => {
      const data = doc.data();
      allProducts.push({ 
        id: doc.id, 
        ...data, 
        isOffer: !!allOffers[doc.id],
        available: data.available !== undefined ? data.available : true,
        stock: data.stock !== undefined ? data.stock : 0,
        maxOrder: data.maxOrder !== undefined ? data.maxOrder : 0,
        unlimitedStock: data.unlimitedStock !== undefined ? data.unlimitedStock : false
      });
    });

    applyFilterAndRender();
  } catch (e) {
    showAlert("âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª", "error");
    console.error(e);
  }
}

function applyFilterAndRender() {
  // Ø·Ø¨Ù‚ ÙÙ„ØªØ± Ø§Ù„Ø¹Ø±Ø¶
  if (currentFilter === "offers") {
    filteredProducts = allProducts.filter(p => p.isOffer);
  } else if (currentFilter === "low-stock") {
    filteredProducts = allProducts.filter(p => p.stock < 10 && p.stock > 0);
  } else if (currentFilter === "unavailable") {
    filteredProducts = allProducts.filter(p => !p.available);
  } else {
    filteredProducts = [...allProducts];
  }

  // Ø·Ø¨Ù‚ ÙÙ„ØªØ± Ø§Ù„Ø¨Ø­Ø«
  const searchTerm = searchInput.value.trim().toLowerCase();
  if (searchTerm) {
    filteredProducts = filteredProducts.filter(p => p.name?.toLowerCase().includes(searchTerm));
  }

  renderProducts(filteredProducts);
}

function renderProducts(products) {
  productsDiv.innerHTML = "";
  if (products.length === 0) {
    productsDiv.innerHTML = "<p style='text-align:center; color:#666;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</p>";
    return;
  }

  products.forEach(product => {
    const profit = product.price && product.cost ? (product.price - product.cost) : 0;
    const safeId = createSafeId(product.id);
    
    const box = document.createElement("div");
    box.className = "product-box";
    
    // Ø¥Ø¶Ø§ÙØ© Ø´Ø§Ø±Ø© "ØºÙŠØ± Ù…ØªÙˆÙØ±" Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ØªÙˆÙØ±
    if (!product.available) {
      const badge = document.createElement("div");
      badge.className = "availability-badge";
      badge.textContent = "ØºÙŠØ± Ù…ØªÙˆÙØ±";
      box.appendChild(badge);
    }
    
    // Ø¥Ø¶Ø§ÙØ© Ø´Ø§Ø±Ø© "Ù…Ø®Ø²ÙˆÙ† ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯" Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù†ØªØ¬ Ø¹Ù„ÙŠÙ‡ "Ø§Ù„Ø´ØºÙ„ Ø¹Ù„ÙŠ Ø§Ù„Ù…ÙƒØ´ÙˆÙ"
    if (product.unlimitedStock) {
      const unlimitedBadge = document.createElement("div");
      unlimitedBadge.className = "unlimited-badge";
      unlimitedBadge.textContent = "Ù…Ø®Ø²ÙˆÙ† ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯";
      box.appendChild(unlimitedBadge);
    }
    
    box.innerHTML = `
      <div class="product-id">
        ğŸ†” ${product.id}
        ${product.isOffer ? '<span style="color: #28a745; font-weight: bold; margin-right: 10px;">ğŸ“¢ Ø¹Ù„Ù‰ Ø¹Ø±Ø¶</span>' : ''}
      </div>
      <input class="name-input" value="${product.name || ''}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" />
      <small>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</small>
      <input style="color: red !important; font-size:25px"  class="cost-input" type="number" value="${product.cost || ''}" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡" />
      <small>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</small>
      <input  style="color: green !important; font-size:25px " class="price-input" type="number" value="${product.price || ''}" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹" />
      ${profit > 0 ? `<div class="profit-info">ğŸ’° Ø§Ù„Ø±Ø¨Ø­: ${profit.toFixed(2)} Ø¬ (${((profit / product.cost) * 100).toFixed(2)}%)</div>` : ''}
      
      <small>Ø§Ù„ÙƒÙ…ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø®Ø²Ù†</small>
      <input class="stock-input" type="number" value="${product.stock || 0}" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø®Ø²Ù†" min="0" />
      
      <small>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø·Ù„Ø¨ (0 = Ù„Ø§ Ø­Ø¯ÙˆØ¯)</small>
      <input class="max-order-input" type="number" value="${product.maxOrder || 0}" placeholder="Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø·Ù„Ø¨" min="0" />
      
      ${product.stock > 0 && !product.unlimitedStock ? 
        `<div class="stock-info">ğŸ“¦ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: ${product.stock} ÙˆØ­Ø¯Ø©</div>` : 
        product.unlimitedStock ?
        `<div class="stock-info" style="color: #9c27b0;">â™¾ï¸ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯</div>` :
        `<div class="stock-info low-stock">â›” Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: Ù†Ø§ÙØ°</div>`}
      
      ${product.maxOrder > 0 ? 
        `<div class="max-order-info">ğŸ“‹ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø·Ù„Ø¨: ${product.maxOrder} ÙˆØ­Ø¯Ø©</div>` : 
        `<div class="max-order-info">ğŸ“‹ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø¯ Ø£Ù‚ØµÙ‰ Ù„Ù„Ø·Ù„Ø¨</div>`}
      
      <div class="availability-checkbox">
        <input type="checkbox" id="available-${safeId}" ${product.available ? 'checked' : ''}>
        <label for="available-${safeId}">Ø§Ù„Ù…Ù†ØªØ¬ Ù…ØªÙˆÙØ±</label>
      </div>
      
      <div class="availability-checkbox">
        <input type="checkbox" id="unlimited-stock-${safeId}" ${product.unlimitedStock ? 'checked' : ''}>
        <label for="unlimited-stock-${safeId}">Ø§Ù„Ø´ØºÙ„ Ø¹Ù„ÙŠ Ø§Ù„Ù…ÙƒØ´ÙˆÙ (Ù…Ø®Ø²ÙˆÙ† ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯)</label>
      </div>
      
      <button class="btn update-btn">ğŸ’¾ ØªØ­Ø¯ÙŠØ«</button>
      <button class="btn delete-btn">ğŸ—‘ï¸ Ø­Ø°Ù</button>
      <button class="btn offer-btn">ğŸ“¢ Ø¹Ø±Ø¶ ÙƒØ¹Ø±Ø¶</button>
      <button class="btn remove-offer-btn">âŒ Ø­Ø°Ù Ø§Ù„Ø¹Ø±Ø¶</button>
      ${product.available ? 
        '<button class="btn availability-btn">âŒ ÙˆØ¶Ø¹ ÙƒØºÙŠØ± Ù…ØªÙˆÙØ±</button>' : 
        '<button class="btn make-available-btn">âœ… ÙˆØ¶Ø¹ ÙƒÙ…ØªÙˆÙØ±</button>'}
      ${product.unlimitedStock ?
        '<button class="btn limited-stock-btn">ğŸ”’ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø´ØºÙ„ Ø¹Ù„ÙŠ Ø§Ù„Ù…ÙƒØ´ÙˆÙ</button>' :
        '<button class="btn unlimited-stock-btn">â™¾ï¸ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø´ØºÙ„ Ø¹Ù„ÙŠ Ø§Ù„Ù…ÙƒØ´ÙˆÙ</button>'}
    `;

    const nameInput = box.querySelector('.name-input');
    const costInput = box.querySelector('.cost-input');
    const priceInput = box.querySelector('.price-input');
    const stockInput = box.querySelector('.stock-input');
    const maxOrderInput = box.querySelector('.max-order-input');
    const updateBtn = box.querySelector('.update-btn');
    const deleteBtn = box.querySelector('.delete-btn');
    const offerBtn = box.querySelector('.offer-btn');
    const removeOfferBtn = box.querySelector('.remove-offer-btn');
    const availabilityBtn = box.querySelector('.availability-btn') || box.querySelector('.make-available-btn');
    const unlimitedStockBtn = box.querySelector('.unlimited-stock-btn') || box.querySelector('.limited-stock-btn');
    const availabilityCheckbox = box.querySelector(`#available-${safeId}`);
    const unlimitedStockCheckbox = box.querySelector(`#unlimited-stock-${safeId}`);

    updateBtn.onclick = async () => {
      const newName = nameInput.value.trim();
      const newCost = parseFloat(costInput.value.trim());
      const newPrice = parseFloat(priceInput.value.trim());
      const newStock = parseInt(stockInput.value.trim());
      const newMaxOrder = parseInt(maxOrderInput.value.trim());
      const newAvailable = availabilityCheckbox.checked;
      const newUnlimitedStock = unlimitedStockCheckbox.checked;
      
      if (!newName || isNaN(newCost) || isNaN(newPrice) || isNaN(newStock) || isNaN(newMaxOrder)) {
        showAlert("âŒ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø³Ø¹Ø± Ø£Ùˆ Ø§Ù„ÙƒÙ…ÙŠØ© ØºÙŠØ± ØµØ§Ù„Ø­Ø©", "error");
        return;
      }
      try {
        await db.collection("products").doc(product.id).set({ 
          name: newName, 
          cost: newCost,
          price: newPrice,
          stock: newStock,
          maxOrder: newMaxOrder,
          available: newAvailable,
          unlimitedStock: newUnlimitedStock
        }, { merge: true });
        showAlert(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬ (${product.id})`);
        await loadProducts();
      } catch (e) {
        showAlert("âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«", "error");
        console.error(e);
      }
    };

    deleteBtn.onclick = async () => {
      if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ (${product.id})ØŸ`)) {
        try {
          await db.collection("products").doc(product.id).delete();
          // Also remove from offers if it exists there
          await db.collection("offers").doc(product.id).delete().catch(() => {});
          showAlert("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬");
          await loadProducts();
        } catch (e) {
          showAlert("âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­Ø°Ù", "error");
        }
      }
    };

    offerBtn.onclick = async () => {
      const name = nameInput.value.trim();
      const price = parseFloat(priceInput.value.trim());
      if (!name || isNaN(price)) {
        showAlert("âŒ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø³Ø¹Ø± ØºÙŠØ± ØµØ§Ù„Ø­", "error");
        return;
      }
      try {
        await db.collection("offers").doc(product.id).set({ name, price });
        showAlert("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±ÙˆØ¶");
        await loadProducts();
      } catch (e) {
        showAlert("âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø±Ø¶", "error");
        console.error(e);
      }
    };

    removeOfferBtn.onclick = async () => {
      try {
        await db.collection("offers").doc(product.id).delete();
        showAlert("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ø±Ø¶ Ù…Ù† Ø§Ù„Ø¹Ø±ÙˆØ¶");
        await loadProducts();
      } catch (e) {
        showAlert("âŒ ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¹Ø±Ø¶", "error");
        console.error(e);
      }
    };

    availabilityBtn.onclick = async () => {
      try {
        const newAvailability = !product.available;
        await db.collection("products").doc(product.id).set({ 
          available: newAvailability 
        }, { merge: true });
        showAlert(`âœ… ØªÙ… ${newAvailability ? 'ØªÙ…ÙƒÙŠÙ†' : 'ØªØ¹Ø·ÙŠÙ„'} Ø§Ù„Ù…Ù†ØªØ¬`);
        await loadProducts();
      } catch (e) {
        showAlert("âŒ ÙØ´Ù„ ÙÙŠ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„ØªÙˆÙØ±", "error");
        console.error(e);
      }
    };

    unlimitedStockBtn.onclick = async () => {
      try {
        const newUnlimitedStock = !product.unlimitedStock;
        await db.collection("products").doc(product.id).set({ 
          unlimitedStock: newUnlimitedStock 
        }, { merge: true });
        showAlert(`âœ… ØªÙ… ${newUnlimitedStock ? 'ØªÙØ¹ÙŠÙ„' : 'Ø¥ÙŠÙ‚Ø§Ù'} Ø§Ù„Ø´ØºÙ„ Ø¹Ù„ÙŠ Ø§Ù„Ù…ÙƒØ´ÙˆÙ`);
        await loadProducts();
      } catch (e) {
        showAlert("âŒ ÙØ´Ù„ ÙÙŠ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†", "error");
        console.error(e);
      }
    };

    productsDiv.appendChild(box);
  });
}

searchInput.addEventListener("input", () => {
  applyFilterAndRender();
});

showAllBtn.onclick = () => {
  currentFilter = "all";
  setActiveFilterButton();
  applyFilterAndRender();
};

showOffersBtn.onclick = () => {
  currentFilter = "offers";
  setActiveFilterButton();
  applyFilterAndRender();
};

showLowStockBtn.onclick = () => {
  currentFilter = "low-stock";
  setActiveFilterButton();
  applyFilterAndRender();
};

showUnavailableBtn.onclick = () => {
  currentFilter = "unavailable";
  setActiveFilterButton();
  applyFilterAndRender();
};

function setActiveFilterButton() {
  // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø§Ø· Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
  showAllBtn.classList.remove("active");
  showOffersBtn.classList.remove("active");
  showLowStockBtn.classList.remove("active");
  showUnavailableBtn.classList.remove("active");
  
  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ø´Ø§Ø· Ù„Ù„Ø²Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯
  if (currentFilter === "all") {
    showAllBtn.classList.add("active");
  } else if (currentFilter === "offers") {
    showOffersBtn.classList.add("active");
  } else if (currentFilter === "low-stock") {
    showLowStockBtn.classList.add("active");
  } else if (currentFilter === "unavailable") {
    showUnavailableBtn.classList.add("active");
  }
}

async function addProduct() {
  const id = document.getElementById("new-id").value.trim();
  const name = document.getElementById("new-name").value.trim();
  const cost = parseFloat(document.getElementById("new-cost").value.trim());
  const price = parseFloat(document.getElementById("new-price").value.trim());
  const stock = parseInt(document.getElementById("new-stock").value.trim());
  const maxOrder = parseInt(document.getElementById("new-max-order").value.trim());
  const available = document.getElementById("new-available").checked;
  const unlimitedStock = document.getElementById("new-unlimited-stock").checked;

  if (!id || !name || isNaN(cost) || isNaN(price) || isNaN(stock) || isNaN(maxOrder)) {
    showAlert("âŒ Ø£Ø¯Ø®Ù„ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­", "error");
    return;
  }

  try {
    await db.collection("products").doc(id).set({ 
      name, 
      cost, 
      price, 
      stock, 
      maxOrder, 
      available,
      unlimitedStock
    });
    showAlert("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬");
    document.getElementById("new-id").value = '';
    document.getElementById("new-name").value = '';
    document.getElementById("new-cost").value = '';
    document.getElementById("new-price").value = '';
    document.getElementById("new-stock").value = '0';
    document.getElementById("new-max-order").value = '0';
    document.getElementById("new-available").checked = true;
    document.getElementById("new-unlimited-stock").checked = false;
    loadProducts();
  } catch (e) {
    showAlert("âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©", "error");
    console.error(e);
  }
}

document.addEventListener("DOMContentLoaded", () => {
  const user = JSON.parse(localStorage.getItem("user"));
  if (!user || user.phone !== "01021502941") {
    alert("ğŸ”’ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø´Ø±Ù Ù„Ø¹Ø±Ø¶ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©");
    window.location.href = "login.html";
    return;
  }
  loadProducts();
});
</script>


<script>
  // Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ù„ØªÙØ¹ÙŠÙ„/Ø¥Ù„ØºØ§Ø¡ "Ø§Ù„Ø´ØºÙ„ Ø¹Ù„ÙŠ Ø§Ù„Ù…ÙƒØ´ÙˆÙ" Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
function addBulkUnlimitedStockButton() {
  const filterButtons = document.getElementById("filter-buttons");
  
  const bulkUnlimitedBtn = document.createElement("button");
  bulkUnlimitedBtn.id = "bulk-unlimited-btn";
  bulkUnlimitedBtn.innerHTML = "â™¾ï¸ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
  bulkUnlimitedBtn.style.backgroundColor = "#6c757d";
  bulkUnlimitedBtn.style.color = "white";
  bulkUnlimitedBtn.style.margin = "20px 10px";
  bulkUnlimitedBtn.style.padding = "10px 20px";
  bulkUnlimitedBtn.style.fontSize = "15px";
  bulkUnlimitedBtn.style.borderRadius = "8px";
  bulkUnlimitedBtn.style.border = "none";
  bulkUnlimitedBtn.style.cursor = "pointer";
  bulkUnlimitedBtn.style.fontWeight = "bold";
  
  // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø§Ù„Ø²Ø± Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  function updateButtonText() {
    if (!allProducts || allProducts.length === 0) {
      bulkUnlimitedBtn.innerHTML = "â™¾ï¸ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
      bulkUnlimitedBtn.style.backgroundColor = "#6c757d";
      bulkUnlimitedBtn.disabled = true;
      return;
    }
    
    const allUnlimited = allProducts.every(product => product.unlimitedStock);
    
    if (allUnlimited) {
      bulkUnlimitedBtn.innerHTML = "ğŸ”’ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø´ØºÙ„ Ø¹Ù„ÙŠ Ø§Ù„Ù…ÙƒØ´ÙˆÙ Ù„Ù„Ø¬Ù…ÙŠØ¹";
      bulkUnlimitedBtn.style.backgroundColor = "#795548";
    } else {
      bulkUnlimitedBtn.innerHTML = "â™¾ï¸ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø´ØºÙ„ Ø¹Ù„ÙŠ Ø§Ù„Ù…ÙƒØ´ÙˆÙ Ù„Ù„Ø¬Ù…ÙŠØ¹";
      bulkUnlimitedBtn.style.backgroundColor = "#9c27b0";
    }
    
    bulkUnlimitedBtn.disabled = false;
  }
  
  bulkUnlimitedBtn.onclick = async function() {
    if (!allProducts || allProducts.length === 0) return;
    
    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    const allUnlimited = allProducts.every(product => product.unlimitedStock);
    const action = !allUnlimited; // Ø¹ÙƒØ³ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    const actionText = action ? "ØªÙØ¹ÙŠÙ„" : "Ø¥Ù„ØºØ§Ø¡";
    
    if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ ${actionText} 'Ø§Ù„Ø´ØºÙ„ Ø¹Ù„ÙŠ Ø§Ù„Ù…ÙƒØ´ÙˆÙ' Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§ØªØŸ`)) {
      return;
    }
    
    try {
      bulkUnlimitedBtn.disabled = true;
      bulkUnlimitedBtn.innerHTML = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...";
      
      const batch = db.batch();
      
      allProducts.forEach(product => {
        const productRef = db.collection("products").doc(product.id);
        batch.update(productRef, { unlimitedStock: action });
      });
      
      await batch.commit();
      showAlert(`âœ… ØªÙ… ${actionText} Ø§Ù„Ø´ØºÙ„ Ø¹Ù„ÙŠ Ø§Ù„Ù…ÙƒØ´ÙˆÙ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª`);
      await loadProducts(); // Ù‡ÙŠØ­Ø¯Ø« Ø§Ù„Ø²Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    } catch (e) {
      showAlert("âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«", "error");
      console.error(e);
      bulkUnlimitedBtn.disabled = false;
      updateButtonText();
    }
  };
  
  // Ø­ÙØ¸ Ø§Ù„Ù…Ø±Ø¬Ø¹ Ù„Ù„Ø¯Ø§Ù„Ø© Ø¹Ù„Ø´Ø§Ù† Ù†Ø³ØªØ¯Ø¹ÙŠÙ‡Ø§ Ù…Ù† Ø£ÙŠ Ù…ÙƒØ§Ù†
  window.updateBulkUnlimitedButton = updateButtonText;
  
  filterButtons.appendChild(bulkUnlimitedBtn);
}

// ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© loadProducts Ø¹Ù„Ø´Ø§Ù† ØªØ­Ø¯Ø« Ø§Ù„Ø²Ø±
async function loadProducts() {
  productsDiv.innerHTML = "Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
  try {
    const [productsSnapshot, offersSnapshot] = await Promise.all([
      db.collection("products").get(),
      db.collection("offers").get()
    ]);

    allOffers = {};
    offersSnapshot.forEach(doc => {
      allOffers[doc.id] = true;
    });

    allProducts = [];
    productsSnapshot.forEach(doc => {
      const data = doc.data();
      allProducts.push({ 
        id: doc.id, 
        ...data, 
        isOffer: !!allOffers[doc.id],
        available: data.available !== undefined ? data.available : true,
        stock: data.stock !== undefined ? data.stock : 0,
        maxOrder: data.maxOrder !== undefined ? data.maxOrder : 0,
        unlimitedStock: data.unlimitedStock !== undefined ? data.unlimitedStock : false
      });
    });

    applyFilterAndRender();
    
    // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø´ØºÙ„ Ø¹Ù„ÙŠ Ø§Ù„Ù…ÙƒØ´ÙˆÙ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if (window.updateBulkUnlimitedButton) {
      window.updateBulkUnlimitedButton();
    }
  } catch (e) {
    showAlert("âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª", "error");
    console.error(e);
  }
}

// Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener("DOMContentLoaded", () => {
  const user = JSON.parse(localStorage.getItem("user"));
  if (!user || user.phone !== "01021502941") {
    alert("ğŸ”’ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø´Ø±Ù Ù„Ø¹Ø±Ø¶ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©");
    window.location.href = "login.html";
    return;
  }
  
  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø²Ø± Ø£ÙˆÙ„Ø§Ù‹ Ø¹Ù„Ø´Ø§Ù† ÙŠØ¸Ù‡Ø± ÙÙˆØ±Ø§Ù‹
  addBulkUnlimitedStockButton();
  
  // Ø«Ù… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  loadProducts();
});
</script>
</body>
</html>