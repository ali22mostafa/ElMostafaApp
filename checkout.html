<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ - Ø´Ø±ÙƒØ© Ø§Ù„Ù…ØµØ·ÙÙ‰</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #111;
      color: #fff;
      margin: 0;
      padding: 0;
    }
    .logo {
      display: block;
      margin: 10px auto;
      max-width: 220px;
      border-radius: 20px;
      animation: bounceIn 1s ease-out, pulse 2s 2s ease-in-out infinite;
      transform-origin: center;
      transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    .logo:hover {
      transform: scale(1.05) rotate(2deg);
    }
    .container {
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
    }
    h1 {
      color: yellow;
      text-align: center;
    }
    .order-summary {
      background-color: #222;
      border: 1px solid yellow;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .order-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #444;
    }
    .customer-form {
      background-color: #222;
      border: 1px solid yellow;
      border-radius: 10px;
      padding: 20px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      color: yellow;
    }
    input, textarea {
      width: 100%;
      padding: 10px;
      border-radius: 5px;
      border: none;
      background-color: #333;
      color: white;
    }
    .submit-btn {
      background-color: yellow;
      color: black;
      border: none;
      padding: 12px 20px;
      border-radius: 5px;
      font-weight: bold;
      font-size: 18px;
      margin-top: 20px;
      cursor: pointer;
      width: 100%;
    }
    .back-btn {
      background-color: #444;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      margin-top: 10px;
      cursor: pointer;
    }

    .back-btn1 {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #0d47a1;
      color: white;
      padding: 10px 16px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: bold;
      z-index: 1000;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      transition: background 0.3s ease;
    }

    .back-btn1:hover {
      background-color: #1565c0;
    }
  </style>
  <style>
    input,
    textarea,
    select {
      font-size: 16px; /* ÙŠÙ…Ù†Ø¹ Ø§Ù„Ø²ÙˆÙ… Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    }
  </style>

  <style>
    /* Ø®Ø· Ø¹Ø±Ø¨ÙŠ Ø£Ù†ÙŠÙ‚ */
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');

    /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ */
    .swal-responsive {
      direction: rtl;
      text-align: right;
      font-family: 'Tajawal', sans-serif;
      font-size: 16px;
      border-radius: 10px;
      padding: 10px;
      width: 90% !important;
      max-width: 500px !important;
      box-sizing: border-box;
    }

    /* Ø¹Ù†ÙˆØ§Ù† Ø¬Ø°Ø§Ø¨ */
    .swal-title {
      font-weight: bold;
      font-size: 20px;
      color: #d97706;
    }

    /* Ø²Ø± Ù…ØªØ¬Ø§ÙˆØ¨ */
    .swal-button {
      background-color: #f59e0b !important;
      color: white !important;
      border: none !important;
      border-radius: 6px !important;
      font-size: 15px !important;
      padding: 10px 25px !important;
      width: 100%;
      max-width: 100px;
      margin: 0 auto;
      display: block;
    }

    .swal-button:hover {
      background-color: #d97706 !important;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  
  <header>
    <img src="img/zz.jpg" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ©" class="logo" />
    <p style="text-align:center;">Ø´Ø±ÙƒØ© Ø§Ù„Ù…ØµØ·ÙÙ‰ Ù„ØªØµÙ†ÙŠØ¹ Ø§Ù„Ù„Ø­ÙˆÙ… ÙˆØ¨ÙŠØ¹ Ø¬Ù…ÙŠØ¹ Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ§Øª</p>
  </header>
  <a href="cart.html" class="back-btn1">â† Ø±Ø¬ÙˆØ¹</a>
  
  <div class="container">
    <h1>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</h1>

    <div class="order-summary">
      <h2>Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨</h2>
      <div id="order-items"><!-- ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ --></div>
      <div style="text-align: right; margin-top: 15px; font-weight: bold;">
        Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="order-total">0</span> Ø¬Ù†ÙŠÙ‡Ø§Ù‹
      </div>
    </div>

    <div class="customer-form">
      <h2>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
      <form id="customer-info-form">
        <div class="form-group">
          <label for="name">Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„*</label>
          <input type="text" id="name" required>
        </div>
        <div class="form-group">
          <label for="phone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ*</label>
          <input type="tel" id="phone" required>
        </div>
        <div class="form-group">
          <label for="address">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <textarea id="address" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <textarea id="notes" rows="3"></textarea>
        </div>
        <button type="submit" class="submit-btn">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</button>
        <button type="button" class="back-btn" onclick="window.location.href='cart.html'">Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©</button>
      </form>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    // ============================================
    // Ø¥Ø¹Ø¯Ø§Ø¯ Firebase - Ù…Ø´Ø±ÙˆØ¹ÙŠÙ† Ù…Ø®ØªÙ„ÙÙŠÙ†
    // ============================================

    // Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø£ÙˆÙ„: Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª (mostafa-products)
    const firebaseConfigProducts = {
      apiKey: "AIzaSyBKtxMNJ3n_YIsy671sbhlk8Qm1yt5uSB4",
      authDomain: "mostafa-products.firebaseapp.com",
      projectId: "mostafa-products",
      storageBucket: "mostafa-products.firebasestorage.app",
      messagingSenderId: "841270845665",
      appId: "1:841270845665:web:f2f857112688b8b8be57a0"
    };

    // Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø«Ø§Ù†ÙŠ: Ù„Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª (pricelistofelmostafa)
    const firebaseConfigOrders = {
      apiKey: "AIzaSyCR_9LTEVlFMnYhGT5JaqR2hG2lu06D9Ow",
      authDomain: "pricelistofelmostafa.firebaseapp.com",
      projectId: "pricelistofelmostafa",
      storageBucket: "pricelistofelmostafa.firebasestorage.app",
      messagingSenderId: "39463931277",
      appId: "1:39463931277:web:02cc42fc88508696b501c4"
    };

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£ÙˆÙ„ Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª
    const appProducts = firebase.initializeApp(firebaseConfigProducts, "products");
    const dbProducts = firebase.firestore(appProducts);

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø«Ø§Ù†ÙŠ Ù„Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª
    const appOrders = firebase.initializeApp(firebaseConfigOrders, "orders");
    const dbOrders = firebase.firestore(appOrders);

    // ============================================
    // Ù…ØªØºÙŠØ±Ø§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù…Ù†Ø¹ Ø§Ù„Ø§Ø²Ø¯ÙˆØ§Ø¬ÙŠØ©
    // ============================================
    let isProcessing = false; // Ù„Ù…Ù†Ø¹ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…ØªÙƒØ±Ø±
    let currentOrderId = null; // Ù„ØªØªØ¨Ø¹ Ø§Ù„Ø£ÙˆØ±Ø¯Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ

    // ============================================
    // Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ø·Ù„Ø¨
    // ============================================
    function displayOrderSummary() {
      const cart = JSON.parse(localStorage.getItem('cart')) || [];
      const container = document.getElementById('order-items');
      let total = 0;
      container.innerHTML = '';

      if (cart.length === 0) {
        container.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„Ø·Ù„Ø¨</p>';
        document.getElementById('order-total').textContent = '0';
        return;
      }

      cart.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'order-item';
        itemDiv.innerHTML = `
          <span>${item.name} (${item.quantity} Ã— ${item.price} Ø¬)</span>
          <span>${(item.quantity * item.price).toFixed(2)} Ø¬</span>
        `;
        container.appendChild(itemDiv);
        total += item.quantity * item.price;
      });

      document.getElementById('order-total').textContent = total.toFixed(2);
    }

    // ============================================
    // Ù…Ù„Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø³Ø¬Ù„Ø§Ù‹ Ø¯Ø®ÙˆÙ„
    // ============================================
    function fillUserData() {
      const user = JSON.parse(localStorage.getItem('user'));
      if (user) {
        document.getElementById('name').value = user.name || '';
        document.getElementById('phone').value = user.phone || '';
        document.getElementById('address').value = user.address || '';
      }
    }

    // ============================================
    // Ø¯Ø§Ù„Ø© Ø®ØµÙ… Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
    // ============================================
    function deductStockFromFirebase(cartItems) {
      const batch = dbProducts.batch();
      const updatePromises = [];
      
      cartItems.forEach(item => {
        const productRef = dbProducts.collection("products").doc(item.id);
        updatePromises.push(
          productRef.get().then(doc => {
            if (doc.exists) {
              const productData = doc.data();
              
              // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù†ØªØ¬ Ø¹Ù„ÙŠÙ‡ "Ø§Ù„Ø´ØºÙ„ Ø¹Ù„ÙŠ Ø§Ù„Ù…ÙƒØ´ÙˆÙ"ØŒ Ù„Ø§ Ù†Ø®ØµÙ… Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
              if (productData.unlimitedStock) {
                console.log(`â™¾ï¸ Ø§Ù„Ù…Ù†ØªØ¬ ${item.name} Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø´ØºÙ„ Ø¹Ù„ÙŠ Ø§Ù„Ù…ÙƒØ´ÙˆÙ - Ù„Ù… ÙŠØªÙ… Ø®ØµÙ… Ø§Ù„Ù…Ø®Ø²ÙˆÙ†`);
                return;
              }
              
              const currentStock = productData.stock || 0;
              const newStock = currentStock - item.quantity;
              
              if (newStock < 0) {
                throw new Error(`Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø®Ø²ÙˆÙ† ÙƒØ§ÙÙŠ Ù„Ù„Ù…Ù†ØªØ¬: ${item.name}`);
              }
              
              batch.update(productRef, { stock: newStock });
              console.log(`ğŸ“‰ Ø®ØµÙ… ${item.quantity} Ù…Ù† Ù…Ø®Ø²ÙˆÙ† ${item.name}. Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø¬Ø¯ÙŠØ¯: ${newStock}`);
            }
          })
        );
      });
      
      return Promise.all(updatePromises)
        .then(() => batch.commit())
        .then(() => {
          console.log("âœ… ØªÙ… Ø®ØµÙ… Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¨Ù†Ø¬Ø§Ø­ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª");
          return true;
        })
        .catch(error => {
          console.error("âŒ ÙØ´Ù„ ÙÙŠ Ø®ØµÙ… Ø§Ù„Ù…Ø®Ø²ÙˆÙ†:", error);
          throw error;
        });
    }

    // ============================================
    // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ØºÙŠØ± Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©
    // ============================================
    function checkPendingOrders(phone, cartItems) {
      return dbOrders.collection('orders')
        .where('customerPhone', '==', phone)
        .where('status', 'in', ['Ø¬Ø¯ÙŠØ¯', 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©'])
        .get()
        .then(querySnapshot => {
          const pendingItems = {};
          
          // Ø¬Ù…Ø¹ ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
          querySnapshot.forEach(doc => {
            const orderData = doc.data();
            orderData.items.forEach(item => {
              if (!pendingItems[item.id]) {
                pendingItems[item.id] = 0;
              }
              pendingItems[item.id] += item.quantity;
            });
          });
          
          // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù…Ø¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
          const promises = [];
          cartItems.forEach(item => {
            const promise = dbProducts.collection("products").doc(item.id).get()
              .then(productDoc => {
                if (productDoc.exists) {
                  const productData = productDoc.data();
                  const totalRequested = (pendingItems[item.id] || 0) + item.quantity;
                  
                  if (productData.maxOrder > 0 && totalRequested > productData.maxOrder) {
                    throw new Error(`Ù„Ù‚Ø¯ ØªØ¬Ø§ÙˆØ²Øª Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø·Ù„Ø¨ Ù…Ù† ${item.name}. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„Ù…Ø³Ù…ÙˆØ­: ${productData.maxOrder} ÙˆØ­Ø¯Ø© (Ù„Ø¯ÙŠÙƒ ${pendingItems[item.id] || 0} ÙˆØ­Ø¯Ø© ÙÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©)`);
                  }
                }
              });
            promises.push(promise);
          });
          
          return Promise.all(promises);
        });
    }

    // ============================================
    // Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙˆØ±Ø¯Ø± Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª
    // ============================================
    function createNewOrder(name, phone, address, notes, cart, total, user) {
      // Ù…Ù†Ø¹ Ø§Ù„Ø§Ø²Ø¯ÙˆØ§Ø¬ÙŠØ©: ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£ÙˆØ±Ø¯Ø± Ø­Ø¯ÙŠØ« Ù„Ù†ÙØ³ Ø§Ù„Ù‡Ø§ØªÙ
      const orderKey = `order_${phone}_${Date.now()}`;
      const recentOrderKey = localStorage.getItem('recent_order_key');
      
      if (recentOrderKey && recentOrderKey === orderKey) {
        throw new Error('Ù„Ù‚Ø¯ Ø£Ø±Ø³Ù„Øª Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹.');
      }
      
      const order = {
        customerName: name,
        customerPhone: phone,
        customerAddress: address || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
        notes: notes || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª',
        items: cart,
        total: total,
        status: 'Ø¬Ø¯ÙŠØ¯',
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        userId: user?.id || null,
        orderKey: orderKey // Ø¥Ø¶Ø§ÙØ© Ù…ÙØªØ§Ø­ ÙØ±ÙŠØ¯ Ù„Ù…Ù†Ø¹ Ø§Ù„Ø§Ø²Ø¯ÙˆØ§Ø¬ÙŠØ©
      };

      // Ø­ÙØ¸ Ø§Ù„Ø£ÙˆØ±Ø¯Ø± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø«Ø§Ù†ÙŠØ© (pricelistofelmostafa)
      return dbOrders.collection('orders').add(order)
        .then(docRef => {
          console.log("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø£ÙˆØ±Ø¯Ø± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© pricelistofelmostafaØŒ Ø§Ù„Ù…Ø¹Ø±Ù:", docRef.id);
          localStorage.setItem('recent_order_key', orderKey);
          currentOrderId = docRef.id;
          return docRef.id;
        });
    }

    // ============================================
    // Ø¯Ø§Ù„Ø© Ø¯Ù…Ø¬ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª ÙÙŠ Ø­Ø§Ù„Ø© ÙˆØ¬ÙˆØ¯ Ø·Ù„Ø¨ Ø³Ø§Ø¨Ù‚
    // ============================================
    function mergeOrders(querySnapshot, name, phone, address, notes, newCart, newTotal, user) {
      const existingOrder = querySnapshot.docs[0];
      const existingData = existingOrder.data();
      
      // Ù…Ù†Ø¹ Ø§Ù„Ø¯Ù…Ø¬ Ø§Ù„Ù…ØªÙƒØ±Ø±: ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù†Ø§ØµØ± ØªÙ…Øª Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø¨Ø§Ù„ÙØ¹Ù„
      const orderMergeKey = `merge_${existingOrder.id}_${Date.now()}`;
      const lastMergeKey = localStorage.getItem('last_merge_key');
      
      if (lastMergeKey && lastMergeKey.startsWith(`merge_${existingOrder.id}_`)) {
        const timeDiff = Date.now() - parseInt(lastMergeKey.split('_')[2]);
        if (timeDiff < 30000) { // 30 Ø«Ø§Ù†ÙŠØ©
          throw new Error('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø·Ù„Ø¨Ùƒ Ø¨Ø§Ù„ÙØ¹Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹.');
        }
      }
      
      const mergedItems = [...existingData.items];
      let itemsChanged = false;
      
      newCart.forEach(newItem => {
        const existingItemIndex = mergedItems.findIndex(item => item.id === newItem.id);
        if (existingItemIndex >= 0) {
          // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø§Ø²Ø¯ÙˆØ§Ø¬ÙŠØ© ÙÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©
          if (mergedItems[existingItemIndex].quantity !== newItem.quantity) {
            mergedItems[existingItemIndex].quantity += newItem.quantity;
            itemsChanged = true;
          }
        } else {
          mergedItems.push(newItem);
          itemsChanged = true;
        }
      });
      
      // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªØºÙŠØ± Ø´ÙŠØ¡ØŒ Ù„Ø§ ØªÙ‚Ù… Ø¨Ø§Ù„ØªØ­Ø¯ÙŠØ«
      if (!itemsChanged && existingData.customerName === name) {
        console.log("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„Ø·Ù„Ø¨ØŒ ØªØ®Ø·ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«");
        return Promise.resolve(existingOrder.id);
      }
      
      const mergedTotal = existingData.total + newTotal;
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙˆØ±Ø¯Ø± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø«Ø§Ù†ÙŠØ©
      return existingOrder.ref.update({
        items: mergedItems,
        total: mergedTotal,
        customerName: name,
        customerAddress: address || existingData.customerAddress,
        notes: notes || existingData.notes,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        lastUpdate: new Date().toISOString()
      })
      .then(() => {
        console.log("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙˆØ±Ø¯Ø± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© pricelistofelmostafa");
        localStorage.setItem('last_merge_key', orderMergeKey);
        currentOrderId = existingOrder.id;
        return existingOrder.id;
      });
    }

    // ============================================
    // Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    // ============================================
    function submitOrder(event) {
      event.preventDefault();
      
      // Ù…Ù†Ø¹ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…ØªÙƒØ±Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±
      if (isProcessing) {
        Swal.fire({
          title: 'â³ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±',
          text: 'Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚...',
          icon: 'info',
          confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹',
          customClass: {
            popup: 'swal-responsive',
            title: 'swal-title',
            confirmButton: 'swal-button'
          }
        });
        return;
      }
      
      isProcessing = true;
      const submitBtn = document.querySelector('.submit-btn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';
      
      const cart = JSON.parse(localStorage.getItem('cart')) || [];

      if (cart.length === 0) {
        Swal.fire({
          title: 'âš ï¸ ØªÙ†Ø¨ÙŠÙ‡',
          text: 'Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚ ÙØ§Ø±ØºØ©!',
          icon: 'warning',
          confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹',
          customClass: {
            popup: 'swal-responsive',
            title: 'swal-title',
            confirmButton: 'swal-button'
          }
        });
        isProcessing = false;
        submitBtn.disabled = false;
        submitBtn.textContent = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨';
        return;
      }

      const name = document.getElementById('name').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const address = document.getElementById('address').value.trim();
      const notes = document.getElementById('notes').value.trim();

      if (!name || !phone) {
        Swal.fire({
          title: 'âš ï¸ ØªÙ†Ø¨ÙŠÙ‡',
          text: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ',
          icon: 'warning',
          confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹',
          customClass: {
            popup: 'swal-responsive',
            title: 'swal-title',
            confirmButton: 'swal-button'
          }
        });
        isProcessing = false;
        submitBtn.disabled = false;
        submitBtn.textContent = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨';
        return;
      }

      const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const user = JSON.parse(localStorage.getItem('user'));

      // Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
      checkPendingOrders(phone, cart)
        .then(() => {
          // Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø·Ù„Ø¨ Ø³Ø§Ø¨Ù‚
          return dbOrders.collection('orders')
            .where('customerPhone', '==', phone)
            .where('status', 'in', ['Ø¬Ø¯ÙŠØ¯', 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©'])
            .get();
        })
        .then(querySnapshot => {
          let orderPromise;
          
          if (querySnapshot.empty) {
            // Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø®ØµÙ… Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
            return deductStockFromFirebase(cart)
              .then(() => {
                // Ø§Ù„Ø®Ø·ÙˆØ© 4: Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙˆØ±Ø¯Ø± Ø¬Ø¯ÙŠØ¯
                return createNewOrder(name, phone, address, notes, cart, total, user);
              });
          } else {
            // Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø®ØµÙ… Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
            return deductStockFromFirebase(cart)
              .then(() => {
                // Ø§Ù„Ø®Ø·ÙˆØ© 4: Ø¯Ù…Ø¬ Ù…Ø¹ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø³Ø§Ø¨Ù‚
                return mergeOrders(querySnapshot, name, phone, address, notes, cart, total, user);
              });
          }
        })
        .then(orderId => {
          console.log("ğŸ‰ ØªÙ…Øª Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ØŒ Ù…Ø¹Ø±Ù Ø§Ù„Ø£ÙˆØ±Ø¯Ø±:", orderId);
          
          // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
          Swal.fire({
            icon: 'success',
            title: 'ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!',
            html: `
              <div style="text-align: right; direction: rtl;">
                
                <p>ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨: <strong>${total.toFixed(2)} Ø¬Ù†ÙŠÙ‡Ø§Ù‹</strong></p>
                <p style="color: #f59e0b; font-weight: bold; margin-top: 15px;">
                  âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø©: ÙÙŠ Ø­Ø§Ù„Ø© Ø£Ù† Ø·Ù„Ø¨Ùƒ Ø£Ù‚Ù„ Ù…Ù† 3000 Ø¬Ù†ÙŠÙ‡ØŒ Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© 50 Ø¬Ù†ÙŠÙ‡ Ø±Ø³ÙˆÙ… ØªÙˆØµÙŠÙ„.
                </p>
                <p style="font-size: 14px; margin-top: 10px;">
                  Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: <strong>${orderId}</strong>
                </p>
              </div>
            `,
            showConfirmButton: true,
            confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹',
            customClass: {
              popup: 'swal-responsive',
              title: 'swal-title',
              confirmButton: 'swal-button'
            }
          }).then(() => {
            // Ù…Ø³Ø­ Ø§Ù„Ø³Ù„Ø© ÙˆØ§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            localStorage.removeItem('cart');
            localStorage.removeItem('recent_order_key'); // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ù…Ø¤Ù‚Øª
            window.location.href = 'index.html';
          });
        })
        .catch(error => {
          console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨:', error);
          
          let errorMessage = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';
          
          if (error.message.includes('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø®Ø²ÙˆÙ†')) {
            errorMessage = error.message;
          } else if (error.message.includes('ØªØ¬Ø§ÙˆØ²Øª Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰')) {
            errorMessage = error.message;
          } else if (error.message.includes('Ø£Ø±Ø³Ù„Øª Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨')) {
            errorMessage = error.message;
          } else if (error.message.includes('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø·Ù„Ø¨Ùƒ')) {
            errorMessage = error.message;
          }
          
          Swal.fire({
            title: 'âŒ Ø®Ø·Ø£',
            text: errorMessage,
            icon: 'error',
            confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹',
            customClass: {
              popup: 'swal-responsive',
              title: 'swal-title',
              confirmButton: 'swal-button'
            }
          });
        })
        .finally(() => {
          // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ø²Ø±
          isProcessing = false;
          submitBtn.disabled = false;
          submitBtn.textContent = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨';
        });
    }

    // ============================================
    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
    // ============================================
    document.addEventListener('DOMContentLoaded', () => {
      displayOrderSummary();
      fillUserData();
      document.getElementById('customer-info-form').addEventListener('submit', submitOrder);
      
      // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
      const now = Date.now();
      const recentOrderKey = localStorage.getItem('recent_order_key');
      if (recentOrderKey) {
        const keyTime = parseInt(recentOrderKey.split('_')[2]);
        if (now - keyTime > 300000) { // 5 Ø¯Ù‚Ø§Ø¦Ù‚
          localStorage.removeItem('recent_order_key');
        }
      }
      
      const lastMergeKey = localStorage.getItem('last_merge_key');
      if (lastMergeKey) {
        const keyTime = parseInt(lastMergeKey.split('_')[2]);
        if (now - keyTime > 300000) { // 5 Ø¯Ù‚Ø§Ø¦Ù‚
          localStorage.removeItem('last_merge_key');
        }
      }
    });
  </script>
</body>
</html>
